<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head><meta name="generator" content="Hexo 3.8.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">









    <link rel="dns-prefetch" href="https://fonts.googleapis.com">





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            并发程序设计：信号量和 PV 操作 | 
        
        RHANQTL
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" href="/img/favicon.png">

    <meta name="format-detection" content="telephone=no">
    <meta name="description" itemprop="description" content="引言摘要
本文介绍并发编程中的信号量和 PV 操作">
    <meta name="keywords" content="">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?NKhlKQkXw/c66TR5p4wO+w==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="RHANQTL">
    <meta name="msapplication-starturl" content="http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="RHANQTL">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="并发程序设计：信号量和 PV 操作 | RHANQTL">
    <meta property="og:image" content="/img/favicon.png">
    <meta property="og:description" content="引言摘要
本文介绍并发编程中的信号量和 PV 操作">
    

    
        <meta property="article:published_time" content="Sat Nov 09 2019 12:00:00 GMT+0800">
        <meta property="article:modified_time" content="Tue Dec 17 2019 10:37:38 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html">
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html",
    "headline": "并发程序设计：信号量和 PV 操作",
    "datePublished": "Sat Nov 09 2019 12:00:00 GMT+0800",
    "dateModified": "Tue Dec 17 2019 10:37:38 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Han Qi",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "RHANQTL",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.png"
        }
    },
    "keywords": "",
    "description": "引言摘要
本文介绍并发编程中的信号量和 PV 操作",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head --><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    

</head>


    
        <body id="scheme-Paradox" class="lazy">
            <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn" class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#引言"><span class="post-toc-number">1.</span> <span class="post-toc-text">引言</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#1-信号量"><span class="post-toc-number">2.</span> <span class="post-toc-text">1    信号量</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-1-信号量的发明"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">1.1    信号量的发明</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-2-信号量的定义"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">1.2    信号量的定义</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-3-信号量的实现"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">1.3    信号量的实现</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-4-二元信号量和互斥锁"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">1.4    二元信号量和互斥锁</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#1-5-AND-型信号量"><span class="post-toc-number">2.5.</span> <span class="post-toc-text">1.5    AND 型信号量</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#2-使用信号量解决并发问题"><span class="post-toc-number">3.</span> <span class="post-toc-text">2    使用信号量解决并发问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-1-生产者-消费者问题"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">2.1    生产者-消费者问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-1-1-生产者-1-消费者-1-缓冲区"><span class="post-toc-number">3.1.1.</span> <span class="post-toc-text">2.1.1    1 生产者 1 消费者 1 缓冲区</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-2-1-生产者-1-消费者-N-缓冲区"><span class="post-toc-number">3.1.2.</span> <span class="post-toc-text">2.1.2    1 生产者 1 消费者 N 缓冲区</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-3-N-生产者-N-消费者-N-缓冲区"><span class="post-toc-number">3.1.3.</span> <span class="post-toc-text">2.1.3    N 生产者 N 消费者 N 缓冲区</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-4-其它形式的生产者-消费者问题"><span class="post-toc-number">3.1.4.</span> <span class="post-toc-text">2.1.4    其它形式的生产者-消费者问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-2-读者-写者问题"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">2.2    读者-写者问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-2-1-读者优先"><span class="post-toc-number">3.2.1.</span> <span class="post-toc-text">2.2.1    读者优先</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-2-2-写者优先"><span class="post-toc-number">3.2.2.</span> <span class="post-toc-text">2.2.2    写者优先</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-3-哲学家就餐问题"><span class="post-toc-number">3.3.</span> <span class="post-toc-text">2.3    哲学家就餐问题</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-1-方案一"><span class="post-toc-number">3.3.1.</span> <span class="post-toc-text">2.3.1    方案一</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-2-方案二"><span class="post-toc-number">3.3.2.</span> <span class="post-toc-text">2.3.2    方案二</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-3-方案三"><span class="post-toc-number">3.3.3.</span> <span class="post-toc-text">2.3.3    方案三</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-4-方案四"><span class="post-toc-number">3.3.4.</span> <span class="post-toc-text">2.3.4    方案四</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-4-睡眠的理发师问题"><span class="post-toc-number">3.4.</span> <span class="post-toc-text">2.4    睡眠的理发师问题</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#2-5-公共汽车问题"><span class="post-toc-number">3.5.</span> <span class="post-toc-text">2.5    公共汽车问题</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#3-POSIX-中的信号量和互斥锁"><span class="post-toc-number">4.</span> <span class="post-toc-text">3    POSIX 中的信号量和互斥锁</span></a></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                并发程序设计：信号量和 PV 操作
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar">
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Han Qi</strong>
        <span>Nov 09, 2019</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=并发程序设计：信号量和 PV 操作&url=http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html&pic=http://yoursite.com/img/favicon.png&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                شارك على Weibo
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=并发程序设计：信号量和 PV 操作&url=http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html&via=Han Qi" target="_blank">
            <li class="mdl-menu__item">
                شارك على Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html" target="_blank">
            <li class="mdl-menu__item">
                شارك على Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html" target="_blank">
            <li class="mdl-menu__item">
                شارك على Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    
        <a class="post_share-link" href="https://www.linkedin.com/shareArticle?mini=true&url=http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html&title=并发程序设计：信号量和 PV 操作" target="_blank">
            <li class="mdl-menu__item">
                شارك على LinkedIn
            </li>
        </a>
    

    <!-- Share QQ -->
    
        <a class="post_share-link" href="http://connect.qq.com/widget/shareqq/index.html?site=RHANQTL&title=并发程序设计：信号量和 PV 操作&summary=&pics=http://yoursite.com/img/favicon.png&url=http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html" target="_blank">
            <li class="mdl-menu__item">
                شارك على QQ
            </li>
        </a>
    

    <!-- Share Telegram -->
    
        <a class="post_share-link" href="https://telegram.me/share/url?url=http://yoursite.com/2019/11/09/concurrency-semaphores-and-pv/index.html&text=并发程序设计：信号量和 PV 操作" target="_blank">
            <li class="mdl-menu__item">
                شارك على Telegram
            </li>
        </a>
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h1><p><strong>摘要</strong></p>
<p>本文介绍并发编程中的信号量和 PV 操作</p>
<a id="more"></a>
<h1 id="1-信号量"><a href="#1-信号量" class="headerlink" title="1    信号量"></a>1    信号量</h1><h2 id="1-1-信号量的发明"><a href="#1-1-信号量的发明" class="headerlink" title="1.1    信号量的发明"></a>1.1    信号量的发明</h2><p>1965 年，荷兰计算机科学家 E. W. Dijkstra 提出了一种新的同步工具 —— 信号量和 PV 操作，他将交通管制中多种颜色的信号灯管理方法引入操作系统，让多个进程通过特殊变量展开交互。一个进程在某一关键点上被迫停止执行直至接收到对应的特殊变量值。通过这一措施，任何复杂的进程交互要求均可得到满足，这种特殊变量就是信号量 (semaphore)。</p>
<h2 id="1-2-信号量的定义"><a href="#1-2-信号量的定义" class="headerlink" title="1.2    信号量的定义"></a>1.2    信号量的定义</h2><p>在操作系统中，我们用信号量表示物理资源的实体。Dijkstra 规定了两种操作：P 操作和 V 操作（荷兰语中“检测” (Proberen) 和 “增量” (Verhogen) 的首字母），这两个操作的功能分别如下：</p>
<ul>
<li>进程执行 P 操作以<strong>申请资源</strong><ul>
<li>如果有可用的资源，那么进程可以继续执行；</li>
<li>如果没有可用的资源，进程就需要等待资源</li>
</ul>
</li>
<li>进程执行 V 操作以<strong>释放资源</strong>，同时，如果有等待这个资源的进程（因执行 P 操作而等待），将其唤醒</li>
</ul>
<h2 id="1-3-信号量的实现"><a href="#1-3-信号量的实现" class="headerlink" title="1.3    信号量的实现"></a>1.3    信号量的实现</h2><p>信号量的一种模拟实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">queue</span> *<span class="title">q</span>;</span></span><br><span class="line">&#125; <span class="keyword">semaphore_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P</span><span class="params">(<span class="keyword">semaphore_t</span> *s)</span> </span>&#123;</span><br><span class="line">    s-&gt;count--;</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 1. 把当前进程插入队列 q</span></span><br><span class="line"><span class="comment">         * 2. 阻塞当前进程</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">V</span><span class="params">(<span class="keyword">semaphore_t</span> *s)</span> </span>&#123;</span><br><span class="line">    s-&gt;count++;</span><br><span class="line">    <span class="keyword">if</span> (s-&gt;count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 1. 把某个进程从队列 q 中移出</span></span><br><span class="line"><span class="comment">         * 2. 将其插入就绪队列</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="1-4-二元信号量和互斥锁"><a href="#1-4-二元信号量和互斥锁" class="headerlink" title="1.4    二元信号量和互斥锁"></a>1.4    二元信号量和互斥锁</h2><p>二元信号量 (binary semaphore) 就是信号量中的计数值只能为 0 或 1 的信号量，它可以沿用上面的实现，或者使用如下新的实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> sem_val &#123; ZERO, ONE &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    sem_val count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">queue</span> *<span class="title">q</span>;</span></span><br><span class="line">&#125; <span class="keyword">binary_semaphore_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">P</span><span class="params">(<span class="keyword">binary_semaphore_t</span> *bs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bs-&gt;count == ZERO) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 1. 把当前进程插入队列 q</span></span><br><span class="line"><span class="comment">         * 2. 阻塞当前进程</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        bs-&gt;count = ZERO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">V</span><span class="params">(<span class="keyword">binary_semaphore_t</span> *bs)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (empty(q)) &#123;</span><br><span class="line">        bs-&gt;count = ONE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 1. 把某个进程从队列 q 中移出</span></span><br><span class="line"><span class="comment">         * 2. 将其插入就绪队列</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>互斥锁跟二元信号量很相似</p>
<h2 id="1-5-AND-型信号量"><a href="#1-5-AND-型信号量" class="headerlink" title="1.5    AND 型信号量"></a>1.5    AND 型信号量</h2><h1 id="2-使用信号量解决并发问题"><a href="#2-使用信号量解决并发问题" class="headerlink" title="2    使用信号量解决并发问题"></a>2    使用信号量解决并发问题</h1><h2 id="2-1-生产者-消费者问题"><a href="#2-1-生产者-消费者问题" class="headerlink" title="2.1    生产者-消费者问题"></a>2.1    生产者-消费者问题</h2><p>并发中一个很常见的问题就是生产者-消费者问题，我们可以先写出程序框架：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        product = produce();</span><br><span class="line">        put(product);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        product = get();</span><br><span class="line">        consume(product);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们用 P 表示生产者，C 表示消费者，那么执行序列应该如下：</p>
<p>P - C - P - C</p>
<p>这里有两个需要同步的地方：</p>
<ul>
<li>消费者需要等待生产者生产完产品之后才能消费</li>
<li>生产者需要等待缓冲区为空</li>
</ul>
<p>生产者、消费者和缓冲区都可以有一个或多个，一共可以组合出 8 个问题，但实际上我们只需要解决其中 3 个：1 生产者 1 消费者 1 缓冲区、1 生产者 1 消费者多缓冲区和多生产者多消费者多缓冲区</p>
<h3 id="2-1-1-1-生产者-1-消费者-1-缓冲区"><a href="#2-1-1-1-生产者-1-消费者-1-缓冲区" class="headerlink" title="2.1.1    1 生产者 1 消费者 1 缓冲区"></a>2.1.1    1 生产者 1 消费者 1 缓冲区</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">product_t</span> buf[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">semaphore_t</span> not_full = <span class="number">1</span>, not_empty = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(&amp;not_full);</span><br><span class="line">        product = produce();</span><br><span class="line">        put(product);</span><br><span class="line">        V(&amp;not_empty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(&amp;not_empty);</span><br><span class="line">        product = get();</span><br><span class="line">        consume(product);</span><br><span class="line">        V(&amp;not_full);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-2-1-生产者-1-消费者-N-缓冲区"><a href="#2-1-2-1-生产者-1-消费者-N-缓冲区" class="headerlink" title="2.1.2    1 生产者 1 消费者 N 缓冲区"></a>2.1.2    1 生产者 1 消费者 N 缓冲区</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">product_t</span> buf[N];</span><br><span class="line"><span class="keyword">semaphore_t</span> not_full = N, not_empty = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> put_ptr = <span class="number">0</span>, get_ptr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(&amp;not_full);</span><br><span class="line">        product = produce();</span><br><span class="line">        buf[put_ptr] = product;</span><br><span class="line">        put_ptr = (put_ptr + <span class="number">1</span>) % N;</span><br><span class="line">        V(&amp;not_empty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(&amp;not_empty);</span><br><span class="line">        product = buf[get_ptr];</span><br><span class="line">        get_ptr = (get_ptr + <span class="number">1</span>) % N;</span><br><span class="line">        consume(product);</span><br><span class="line">        V(&amp;not_full);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-3-N-生产者-N-消费者-N-缓冲区"><a href="#2-1-3-N-生产者-N-消费者-N-缓冲区" class="headerlink" title="2.1.3    N 生产者 N 消费者 N 缓冲区"></a>2.1.3    N 生产者 N 消费者 N 缓冲区</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">product_t</span> buf[N];</span><br><span class="line"><span class="keyword">semaphore_t</span> not_full = N, not_empty = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> put_ptr = <span class="number">0</span>, get_ptr = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 多个生产者/消费者共享 put_ptr/get_ptr，</span></span><br><span class="line"><span class="comment"> * 它们变成了临界资源，所以需要互斥锁</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">mutex_t</span> mutex_put, mutex_get;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">producer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(&amp;not_full);</span><br><span class="line">        P(&amp;mutex_put);</span><br><span class="line">        product = produce();</span><br><span class="line">        buf[put_ptr] = product;</span><br><span class="line">        put_ptr = (put_ptr + <span class="number">1</span>) % N;</span><br><span class="line">        V(&amp;mutex_put);</span><br><span class="line">        V(&amp;not_empty);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(&amp;not_empty);</span><br><span class="line">        P(&amp;mutex_get);</span><br><span class="line">        product = buf[get_ptr];</span><br><span class="line">        get_ptr = (get_ptr + <span class="number">1</span>) % N;</span><br><span class="line">        consume(product);</span><br><span class="line">        V(&amp;mutex_get);</span><br><span class="line">        V(&amp;not_full);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-1-4-其它形式的生产者-消费者问题"><a href="#2-1-4-其它形式的生产者-消费者问题" class="headerlink" title="2.1.4    其它形式的生产者-消费者问题"></a>2.1.4    其它形式的生产者-消费者问题</h3><p>苹果橘子问题、工厂生产问题</p>
<h2 id="2-2-读者-写者问题"><a href="#2-2-读者-写者问题" class="headerlink" title="2.2    读者-写者问题"></a>2.2    读者-写者问题</h2><p>要求：</p>
<ol>
<li>任意数量的读进程可以同时读这个文件</li>
<li>一次只能有一个写进程写文件</li>
<li>若一个写进程正在写文件，则禁止任何读进程读文件</li>
</ol>
<h3 id="2-2-1-读者优先"><a href="#2-2-1-读者优先" class="headerlink" title="2.2.1    读者优先"></a>2.2.1    读者优先</h3><p>解决读者-写者问题最朴素的办法就是设置一个互斥锁，每次只允许一个进程进入。但这样并不符合第 1 条要求，同时也没有任何实用价值。</p>
<p>我们可以考察一个时段内进行的过程。</p>
<ol>
<li>一开始，一个读进程进入</li>
<li>写进程想要进入，但由于已经有读进程，所以阻塞</li>
<li>若干个读进程到来，进入临界区读</li>
<li>所有的读进程退出</li>
<li>写进程进入写</li>
</ol>
<p>我们可以发现，第一个进入的读进程和最后一个退出的读进程才会影响进入的“门槛”，而其他的读进程不会产生任何影响。那么我们就应该在第一个读进程和最后一个退出的读进程时设置一些锁，把写进程挡在外面。那么怎么直到是不是第一个/最后一个呢？可以使用一个计数器。另外，这个计数器是读者共享的，所以要有一个附加的互斥锁来保证其正确性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mutex_t</span> wmutex, x;</span><br><span class="line"><span class="keyword">int</span> read_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(x);</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * read_count &lt;= 0 说明之前没有读者，再分为两种情况：</span></span><br><span class="line"><span class="comment">         * 1. 已经有写者，那么读者会因 P(wmutex) 而阻塞</span></span><br><span class="line"><span class="comment">         * 2. 没有写者，那么读者就可以继续进行，同时由于 read_count++，</span></span><br><span class="line"><span class="comment">         *    后续的读者不会再上锁</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (read_count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            P(wmutex);</span><br><span class="line">        &#125;</span><br><span class="line">        read_count++;</span><br><span class="line">        V(x);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ... 读数据</span></span><br><span class="line"></span><br><span class="line">        P(x);</span><br><span class="line">        read_count--;</span><br><span class="line">        <span class="comment">// 最后一个退出的读者要解锁</span></span><br><span class="line">        <span class="keyword">if</span> (read_count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            V(wmutex);</span><br><span class="line">        &#125;</span><br><span class="line">        V(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(wmutex);</span><br><span class="line">        <span class="comment">// ... 写数据</span></span><br><span class="line">        V(wmutex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="2-2-2-写者优先"><a href="#2-2-2-写者优先" class="headerlink" title="2.2.2    写者优先"></a>2.2.2    写者优先</h3><p>// TODO</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mutex_t</span> rmutex, wmutex, x, y, z;</span><br><span class="line"><span class="keyword">int</span> read_count = <span class="number">0</span>, write_count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(z);</span><br><span class="line">        P(rmutex);</span><br><span class="line">        P(x);</span><br><span class="line">        <span class="keyword">if</span> (read_count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            P(wmutex);</span><br><span class="line">        &#125;</span><br><span class="line">        read_count++;</span><br><span class="line">        V(x);</span><br><span class="line">        V(rmutex);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... 读数据</span></span><br><span class="line">        </span><br><span class="line">        P(x);</span><br><span class="line">        read_count--;</span><br><span class="line">        <span class="keyword">if</span> (read_count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            V(wmutex);</span><br><span class="line">        &#125;</span><br><span class="line">        V(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(y);</span><br><span class="line">        <span class="keyword">if</span> (write_count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            P(rmutex);</span><br><span class="line">        &#125;</span><br><span class="line">        write_count++;</span><br><span class="line">        V(y);</span><br><span class="line">        </span><br><span class="line">        P(wmutex);</span><br><span class="line">        <span class="comment">// ... 写数据</span></span><br><span class="line">        V(wmutex);</span><br><span class="line">        </span><br><span class="line">        P(y);</span><br><span class="line">        write_count--;</span><br><span class="line">        <span class="keyword">if</span> (write_count &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            V(rmutex);</span><br><span class="line">        &#125;</span><br><span class="line">        V(y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-3-哲学家就餐问题"><a href="#2-3-哲学家就餐问题" class="headerlink" title="2.3    哲学家就餐问题"></a>2.3    哲学家就餐问题</h2><h3 id="2-3-1-方案一"><a href="#2-3-1-方案一" class="headerlink" title="2.3.1    方案一"></a>2.3.1    方案一</h3><h3 id="2-3-2-方案二"><a href="#2-3-2-方案二" class="headerlink" title="2.3.2    方案二"></a>2.3.2    方案二</h3><h3 id="2-3-3-方案三"><a href="#2-3-3-方案三" class="headerlink" title="2.3.3    方案三"></a>2.3.3    方案三</h3><h3 id="2-3-4-方案四"><a href="#2-3-4-方案四" class="headerlink" title="2.3.4    方案四"></a>2.3.4    方案四</h3><h2 id="2-4-睡眠的理发师问题"><a href="#2-4-睡眠的理发师问题" class="headerlink" title="2.4    睡眠的理发师问题"></a>2.4    睡眠的理发师问题</h2><p>1 个理发师 1 把理发椅 n 个等待位，有如下规则：</p>
<ul>
<li>没有顾客时，理发师睡眠</li>
<li>顾客到来<ul>
<li>如果理发师正在睡眠，唤醒理发师</li>
<li>如果理发师正在给客人理发，那么顾客去等待位等待<ul>
<li>如果有空的等待位，客人等待</li>
<li>如果没有等待位，客人离开</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> waiting_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">mutex_t</span> x;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> busy = <span class="literal">false</span>;</span><br><span class="line"><span class="keyword">mutex_t</span> y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">semaphore_t</span> customer = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">barber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(customer);</span><br><span class="line">        </span><br><span class="line">        P(x);</span><br><span class="line">        <span class="keyword">if</span> (waiting_count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            waiting_count--;</span><br><span class="line">        &#125;</span><br><span class="line">        V(x);</span><br><span class="line">        </span><br><span class="line">        P(y);</span><br><span class="line">        busy = <span class="literal">true</span>;</span><br><span class="line">        V(y);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... 给客人理发</span></span><br><span class="line">        </span><br><span class="line">        P(y);</span><br><span class="line">        busy = <span class="literal">false</span>;</span><br><span class="line">        V(y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        V(customer);</span><br><span class="line">        P(y);</span><br><span class="line">        <span class="keyword">if</span> (busy) &#123;</span><br><span class="line">            V(y);</span><br><span class="line">            P(x);</span><br><span class="line">            <span class="keyword">if</span> (waiting_count &lt; N) &#123;</span><br><span class="line">                waiting_count++;</span><br><span class="line">                <span class="comment">// ... 顾客坐下等待</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 注意这里</span></span><br><span class="line">                P(customer);</span><br><span class="line">                <span class="comment">// ... 顾客离开</span></span><br><span class="line">            &#125;</span><br><span class="line">            V(x);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            V(y);</span><br><span class="line">            <span class="comment">// ... 顾客接受理发</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码不是很优雅，我们要尝试着改进。</p>
<p>我们先从 <code>barber</code> 的第一个 if 判断开始修改，怎么才能去掉这个判断呢？这个判断之所以存在，是因为第一个顾客来的时候直接理发，不会对 waiting_count 加 1，那我们就可以把第一个顾客和其他顾客统一起来 —— 也就是说任何一个顾客来的时候都对 waiting_count 加 1，从逻辑上来讲，就是每个顾客都会先到等待位等待，那么我们就必须在 +1 之前检查是否有空位，如果有空位，对其 +1，否则直接离开。同时，我们必须要保证在理发师进行 waiting_count— 之前进行 waiting_count++</p>
<p>另外，等待理发师也不需要那么复杂，完全可以将其设为一个互斥量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> waiting_count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">mutex_t</span> x;</span><br><span class="line"></span><br><span class="line"><span class="keyword">mutex_t</span> barber;</span><br><span class="line"></span><br><span class="line"><span class="keyword">semaphore_t</span> customer;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">barber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(customer);</span><br><span class="line">        </span><br><span class="line">        P(x);</span><br><span class="line">        waiting_count--;</span><br><span class="line">        V(x);</span><br><span class="line">        V(barber);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... 给顾客理发</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">customer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(x);</span><br><span class="line">        <span class="keyword">if</span> (waiting_count &lt; N) &#123;</span><br><span class="line">            waiting_count++;</span><br><span class="line">            V(x);</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 注意这句被移到了这里，这是因为必须保证在理发师 -1 之前 +1，</span></span><br><span class="line"><span class="comment">             * 否则可能会使 waiting_count 的结果不正确</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            V(customer);</span><br><span class="line">            P(barber);</span><br><span class="line">            <span class="comment">// ... 理发</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            V(x);</span><br><span class="line">            <span class="comment">// ... 顾客离开</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-5-公共汽车问题"><a href="#2-5-公共汽车问题" class="headerlink" title="2.5    公共汽车问题"></a>2.5    公共汽车问题</h2><p><strong>问题</strong>    汽车司机与售票员之间必须协同工作：一方面，只有售票员把车门关好了司机才能开车，因此售票员关好门应通知司机开车。另一方面，只有当汽车已经停下，售票员才能开门上下客，故司机停车后应通知售票员。假定某公共汽车上有一名司机与两名售票员，汽车目前正在始发站停车上客，试用信号量与 PV 操作写出他们的同步算法。</p>
<p><strong>分析</strong>    可以注意到有两个很明显的同步关系：</p>
<ul>
<li>司机 等待 售票员 关好门</li>
<li>售票员 等待 司机 停好车</li>
</ul>
<p>因此，应该有两个信号量分别表示“门已关好”（ok_to_drive）和“车已停好”（stopped）。</p>
<p>另外，虽然两个售票员都可以通知司机，但是司机只能被通知一次（否则会导致混乱），所以必须要有一种机制避免司机被重复通知。可以引入一个 bool 值用以表示司机是否已经被通知（driver_signaled）（因此需要一个互斥锁保证其读写正确性）。</p>
<p>与通知司机类似，两个售票员都可以等待上客并关门，但我们希望当一个售票员关门之后，另一个售票员也停止等待上客，准备通知司机，故也需要一个 bool 值用以表示门已关上（door_closed）（同样也需要一个互斥锁）。</p>
<p>可以写出如下的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">procedure <span class="title">driver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(ok_to_drive);</span><br><span class="line">        </span><br><span class="line">        P(x);</span><br><span class="line">        driver_signaled = <span class="literal">false</span>;</span><br><span class="line">        V(x);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... 开车，到站</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 开门并通知售票员</span></span><br><span class="line">        P(y);</span><br><span class="line">        door_closed = <span class="literal">false</span>;</span><br><span class="line">        V(y);</span><br><span class="line">        P(stopped[<span class="number">0</span>]);</span><br><span class="line">        P(stopped[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">procedure <span class="title">conductor</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(stopped[id]);</span><br><span class="line">        </span><br><span class="line">        P(y);</span><br><span class="line">        <span class="keyword">if</span> (!door_closed) &#123;</span><br><span class="line">            <span class="comment">// ... 等待上客，关门</span></span><br><span class="line">            door_closed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        V(y);</span><br><span class="line">        </span><br><span class="line">        P(x);</span><br><span class="line">        <span class="keyword">if</span> (!driver_signaled) &#123;</span><br><span class="line">            V(ok_to_drive);</span><br><span class="line">            driver_signaled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        V(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个方案可行吗？并不。</p>
<p>设想这样一种情况：</p>
<ol>
<li>某个售票员唤醒 driver，并将 driver_signaled 设为 true</li>
<li>driver 将 driver_signaled 设为 false</li>
<li>另一个售票员（错误地）再次唤醒 driver，并将 driver_signaled 设为 true</li>
</ol>
<p>这种情况下，下一次 driver 进行 <code>P(ok_to_drive)</code> 操作时，就无法起到阻塞的效果，导致混乱</p>
<p>如何解决呢？错误的原因在于 driver 重置 <code>driver_signaled</code> 的操作可以在两个 conductor 通知操作之间进行，所以我们可以强制 driver 在两个 conductor 都完成通知操作之后再进行重置，也就是说，在两个 conductor 都完成通知操作之前，driver 等待，后一个 conductor 完成通知操作之后，再将 driver 唤醒执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">semaphore ok_to_drive = <span class="number">0</span>, stopped[<span class="number">2</span>] = &#123; <span class="number">1</span>, <span class="number">1</span> &#125;;</span><br><span class="line">semaphore barrier = <span class="number">0</span>;</span><br><span class="line">semaphore x = <span class="number">1</span>, y = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">bool</span> door_closed = <span class="literal">false</span>, driver_signaled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">procedure <span class="title">driver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(ok_to_drive);</span><br><span class="line">        </span><br><span class="line">        P(barrier);</span><br><span class="line">        </span><br><span class="line">        P(x);</span><br><span class="line">        driver_signaled = <span class="literal">false</span>;</span><br><span class="line">        counter = <span class="number">0</span>;</span><br><span class="line">        V(x);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ... 驾驶</span></span><br><span class="line">        </span><br><span class="line">        P(y);</span><br><span class="line">        door_closed = <span class="literal">false</span>;</span><br><span class="line">        V(y);</span><br><span class="line">        V(stopped[<span class="number">0</span>]);</span><br><span class="line">        V(stopped[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">procedure <span class="title">conductor</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        P(stopped[i]);</span><br><span class="line">        </span><br><span class="line">		P(y);</span><br><span class="line">        <span class="keyword">if</span> (!door_closed) &#123;</span><br><span class="line">            <span class="comment">// ... 等待上客</span></span><br><span class="line">            door_closed = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        V(y);</span><br><span class="line">        </span><br><span class="line">        P(x);</span><br><span class="line">        <span class="keyword">if</span> (!driver_signaled) &#123;</span><br><span class="line">            V(ok_to_drive);</span><br><span class="line">            driver_signaled = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        counter++;</span><br><span class="line">        <span class="keyword">if</span> (counter == <span class="number">2</span>) &#123;</span><br><span class="line">            V(barrier);</span><br><span class="line">        &#125;</span><br><span class="line">        V(x);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="3-POSIX-中的信号量和互斥锁"><a href="#3-POSIX-中的信号量和互斥锁" class="headerlink" title="3    POSIX 中的信号量和互斥锁"></a>3    POSIX 中的信号量和互斥锁</h1>
        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2019/11/15/concurrency-monitor/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            أحدث
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2019/11/09/concurrency-conditional-variables/" id="post_nav-older" class="next-content">
            أقدم
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Han Qi's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        my@rhanqtl.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                الرئيسية
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    أرشيف
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2019/12/">December 2019<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/11/">November 2019<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/10/">October 2019<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/09/">September 2019<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/08/">August 2019<span class="sidebar_archives-count">10</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/07/">July 2019<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/06/">June 2019<span class="sidebar_archives-count">21</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/05/">May 2019<span class="sidebar_archives-count">36</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/04/">April 2019<span class="sidebar_archives-count">46</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/03/">March 2019<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/02/">February 2019<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2019/01/">January 2019<span class="sidebar_archives-count">17</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/12/">December 2018<span class="sidebar_archives-count">26</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/11/">November 2018<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2018/10/">October 2018<span class="sidebar_archives-count">1</span></a>
            </li></ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    

    <!-- Article Number  -->
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/viosey/hexo-theme-material" class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            سمة - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/rhanqtl" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-github">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year=""></span>&nbsp;RHANQTL
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?Bn9UzEm8RrBSxqyZB0zPjA==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 0000;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
        </body>
    
</html>
